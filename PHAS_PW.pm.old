package PHAS_PW;

#use lib '/opt/sysadmin/common/passwd/';
use lib ".";
use PHAS_PW_Utils;
use Carp;
#qw[ Ask get_username get_category
#					get_studentnumber  get_uid		get_gid
#					get_homedir        get_expdate
#					get_diskquota      get_account confirm_input
#					];

my $passwddir ="/opt/sysadmin/common/passwd/";
my $userdb    = $passwddir."users.db";		# data file for existing ids
my $aliases   = $passwddir."aliases";          # valid email addresses file

my $pwfile   = "/etc/passwd";		# system passwd file
my $shadow   = "/etc/shadow";		# system shadow file
my $grpfile  = "/etc/group";		# system group file
my $smbfile  = "/etc/samba/smbpasswd";		# system Samba pw file 

my $approp  = $passwddir."appropriate.txt"; 	# UBC's Appropriate Use statement
my $pwhelp  = $passwddir."passwd.txt";		# help info. on password setting

my $prntsvr = "prntsvr";

my $Home_Archive = "/home/ARCHIVED";

1;

sub copy_files {
	use File::Basename;
	use File::Copy;
	use Date::Calc qw (Today);
	$olddir = "$passwddir/archive/";

	my $iso = sprintf "%4.4d-%2.2d-%2.2d", Today();

	foreach my $file ( $pwfile, $shadow, $grpfile, $smbfile  ) {
		$base = basename($file);
		$savefile = $oldir . $base . ".$iso";
        copy($file,$savefile) or die "Copy of $file failed: $!";
	}

}

sub createid {

    my $udata_ref = shift;
    my %udata = %{$udata_ref};

    update_unix_files($udata_ref);
    update_usersDB($udata_ref);
    
    my $protodir = "/home/prototype/default";
	print "createid: line 56 ; home dir is [$udata{homedir}]\n";
    PHAS_PW_Utils::mk_homedir ($udata{uid}, $udata{gid}, $udata{homedir}, $protodir);    # from PHAS_PW_Utils

    pykota_account( $udata{username}, $udata{printquota} ); 

    do_mail( $udata{username},  $udata{homedir}, $udata{uid}, $udata{gid},  $udata{category} );  
}

sub update_unix_files {
    my $udata_ref = shift;
    my %udata = %{$udata_ref};
                  
    open(PW, ">>", $pwfile) or die "ERROR: Can't open $pwfile! ";
    print PW "$udata{username}:x:$udata{uid}:$udata{gid}:$udata{fullname}:$udata{homedir}:$udata{shell}\n";
    close(PW);

    open (SH, ">>",$shadow) or die "ERROR: Can't open $shadow! ";
    print SH "$udata{username}:*no login*:9962::::::\n";
    close SH;
    
    ## Add username to group file
    open (GRPFILE, ">>",$grpfile) or die "ERROR: Can't open $grpfile! ";
    print GRPFILE "$udata{username}:x:$udata{gid}:\n";
    close GRPFILE;
	    
}
sub  update_usersDB {
    
    my $udata_ref = shift;
    my %udata = %{$udata_ref};
                  
    open (USERDB, ">>",$userdb) or die "ERROR: Can't open $userdb! ";
    print USERDB "$udata{username}:$udata{fullname}:$udata{account}:$udata{category}:$udata{expdate}::$udata{studentno}::$udata{CWL}\n";
    close USERDB;

}

sub pykota_account {
    my $username   = shift;
    my $printquota = shift;
    
    print "\nCreating Pykota account for user ......... \n";
 
    # set pkusers command to create user
    if ( $printquota ) {  				# undergrads don't get a pykota entry until they pay
										# either unlimited printing or has initial quota
        if ( $printquota == "#" ) { 	# unlimited printing 
    	    $pk_cmd = "ssh $prntsvr 'pkusers --add --email \@phas.ubc.ca --limitby noquota $username'";
        } else {							# has an initial quota
    	    $pk_cmd = "ssh $prntsvr 'pkusers --add --email \@phas.ubc.ca --limitby balance --balance $printquota $username'";
        }
        # set edpykota command to allow user to print to any printer
        $ed_cmd = "ssh $prntsvr 'edpykota --add $username'";
    } 

    # execute commands on print server -- this is bogus untaint...
    if ($pk_cmd =~ /^(.*)$/){ $pk_cmd = $1; print "$pk_cmd\n"; system($pk_cmd); }
    if ($ed_cmd =~ /^(.*)$/){ $ed_cmd = $1; print "$ed_cmd\n"; system($ed_cmd); }
    
}

sub do_mail {
    my $username = shift;
    my $homedir  = shift;
    my $uid      = shift;
    my $gid      = shift;
    my $cat      = shift;
    
    # Set up files on mail server (enabled for "everyone" only)
    my @cat_mails = PHAS_PW_Utils::get_catmail();
    my $mh_cmd = "/opt/sysadmin/passwd/mkhome.sh $username $homedir $uid $gid ";
    my $enable =  ( grep $cat, @cat_mails )
                ? "ENABLE" : "DISABLE";
    $mh_cmd .= $enable;

   print "\nSetting up mail files ......... \n";
   my $ssh_cmd = "/usr/bin/ssh";
   my $mailhost = "mail";
   my @args = ($ssh_cmd, $mailhost, $mh_cmd);

   print "$ssh_cmd $mailhost $mh_cmd\n";
   system(@args) == 0 or die " ssh to $mailhost failed\n";

    if ( grep $cat, @cat_mails ) {
        # Subscribe to events@phas list
        print "\nAdding to events list ......... \n";
        system "/bin/echo $username\@phas.ubc.ca >> /opt/sysadmin/common/passwd/new_events.list";
    }
}

sub get_user_info {
    
# set path so that grep command works for different architectures
    $ENV{'PATH'} = '/sbin:/bin:/usr/bin:/usr/local/bin:/usr/ucb:/usr/bsd';
# set backspace to erase
#`stty erase '^H'`;

    my %user_data = ();

INPUT_USER_PARAMETERS:

    print "\n\nPlease provide the following information: \n";
    $user_data{category}   = get_category();
    $user_data{studentno}  = get_studentnumber($user_data{category});
    $user_data{CWL}        = Ask ("Enter CWL");
    $user_data{lastname}   = Ask ("Enter Lastname");
    $user_data{firstname}  = Ask ('Enter First Name');
#    my ($guess) = lc( $1 . $user_data{lastname})  if $user_data{firstname} =~ /^(\w)/;		# get bboop from "Betty Boop" guess for useranme
    my $guess = $user_data{CWL};
    $user_data{username}   = get_username ($guess);
    $user_data{fullname}   = $user_data{lastname} . " " . $user_data{lastname};
    $user_data{uid}        = get_uid($user_data{category});
    $user_data{gid}        = get_gid($user_data{uid});
    $user_data{shell}      = "/bin/bash";
    $user_data{homedir}    = get_homedir($user_data{category}, $user_data{username} );
    $user_data{expdate}    = get_expdate($user_data{category});
    $user_data{diskquota}  = get_diskquota($user_data{category});
    $user_data{account}    = get_account($user_data{category});
    $user_data{printquota} = "#"; 

    my $ans = confirm_input ( \%user_data);
    if ( $ans =~ /^N/i) { goto INPUT_USER_PARAMETERS; }
	
	print "------------------------------------------------------------------------\n";
	print "------------------------------------------------------------------------\n";
	print "Creating id ...\n";
	my $gcos = "$firstname "."$lastname";
#	createid ( \%user_data );
	print "get_user_info:: 184 home isr is [$user_data{homedir}]\n";
    return \%user_data;
}

sub mk_pgs_bottoms  {
    my $dst_file_login   =  "/opt/sysadmin/common/passwd/passwd.bot";
    my $dst_file_nologin = "/opt/sysadmin/common/passwd/passwd.nologin.bot";
    system ("sed -n '/splitz/,\$p' /etc/passwd > $dst_file_login");
    
    open (BOT, "<", $dst_file_login)      || die "Cannot open file $dst_file_login\n";
    open (NOLOGIN, ">",$dst_file_nologin) || die "Cannot open file $dst_file_nologin\n";

    my @exceptions = qw ( rap grieve hongyun );
    foreach $line (<BOT>) { 
        my ($uname,$pw,$uid,$gid,$gcos,$hdir,$shell) = split /:/, $line;
        if ( grep( /^$uname$/, @exceptions ) ) { $shell = "/bin/bash"; }
        else                                   { $shell = "/sbin/nologin"; }
        
        print NOLOGIN "$uname:$pw:$uid:$gid:$gcos:$hdir:$shell\n";
    }
    close BOT;
    close NOLOGIN;
    
    
## shadow bottom...
    system ("sed -n '/splitz/,\$p' /etc/shadow >/etc/shadow.bot");
    system ("cp /etc/shadow.bot /opt/sysadmin/common/passwd/shadow.bot");
    
    system ("sed -n '/splitz/,\$p' /etc/group >/etc/group.bot");
    system ("cp /etc/group.bot /opt/sysadmin/common/passwd/group.bot");
    print " \n";
    print "======================================================================\n";
    print " NOTE   NOTE   NOTE   NOTE   NOTE   NOTE   NOTE   NOTE   NOTE   NOTE \n";
    print "======================================================================\n";
    print "Please manually update the LDAP servers with the changed group info:\n";
    print " LDAP:  https://ldap.phas.ubc.ca/lam/templates/login.php  (Manager)\n";
    print " LDAP2: https://ldap2.phas.ubc.ca/lam/templates/login.php (Manager)\n";
    print " IPA02: https://ipa02.phas.ubc.ca/ipa/ui/index.html       (admin)\n";
    print "======================================================================\n";
    print " \n";
}

sub pgs_propagate {
	use Sys::Hostname;
	my $DEBUG = shift;
    # Invoke pgs_get command on each server - will rsync appropriate files (incl. /etc/samba/smbpasswd)
   my $SSHCMD = "/usr/bin/ssh";
   my $remote_cmd = $DEBUG ? "/opt/sysadmin/common/passwd/pgs_get_fake"
                           : "/usr/local/sbin/pgs_get";
   # an apparently undocumented part of running suid perl programs
   # it still isn't going to "just run setuid." 
   # you have to change your uid within your perl code, something like this. 
   my $real_user_id       = $<; # Grab all the original values
   my $effective_user_id  = $>; # so we can reset everything 
   my $real_group_id      = $(; # when we are done with root access
   my $effective_group_id = $); # 
   $< = $> = 0;                     # 0 is almost always OWNER root
   $( = $) = 0;                     # 0 is almost always GROUP wheel

   my $ServerName =  (split /\./, hostname())[0]; ## get the short name from the FQDN
   print "$ServerName \n\n";
   print "Please wait, updating ";  #DEBUG
 
   my @newServers = qw( beta delta hyper mail omega tau zorok );
   foreach my $newserver ( @newServers ) {
       if ( $newserver ne $ServerName ) {
          print "..$newserver";  #DEBUG
          system( "$SSHCMD", "root\@$newserver", "$remote_cmd $ServerName" );
       }
   }
   print "..done. \n";

   $< = $real_user_id;          # Set everything back to original
   $> = $effective_user_id;     # values.
   $( = $real_group_id;         # 
   $) = $effective_group_id;    # 
}

sub delete_homedir {

    my $homedir = shift;
    use File::Path;
	use File::Basename;

    my $symlink;
	print "home dir is [$homedir]\n";
	if (defined ($symlink = readlink($homedir)))  {
        $homedir = $symlink;
		print "the symlink is {$symlink} home is really {$homedir}\n";
		croak "I do not handle symlinks, yet\n";
    }
    
	if ( -d $homedir ) {
		list_homefiles($homedir);
		
        my $ans = Ask("What to do with files in  $homedir directory Del or Archive", "Arch");
     
        if ( $ans =~ /ARCH/i ) {            #Archive then delete...
			$user = basename($homedir);
			my $tfile = $user . ".tar.gz";
            my $tar_cmd = "tar -czf $Home_Archive/$tfile -C $homedir .";
            my $result = system("$tar_cmd $homedir");
        }

        rmtree([ $homedir ]);        
        unlink $symlink if ( $symlink );
	exit;
 
    } else {
        print "*** No home directory found ***";
    }
    print "\n--------------------------------------\n";
    return;
}

sub list_homefiles {

    my $homedir = shift;
    print "Here is what is in $homedir:\n";
    my @files = glob("$homedir/*");
      
    my $i = 1;
    my $ncols = 3;
    foreach my $f ( @files) {
		$f =~s/^$homedir\///;
        printf "%28s", $f;
        print "\n" unless ($i%$ncols);
        $i++;
    }
	print "\n";
    return;
}

sub delete_Mailfiles {

    my $homedir = shift;
    if ( ! system ( "$ssh_cmd mail rm -R $homedir") ) { 
            print "*** Please delete the MAIL:$homedir directory manually.\n";
    }
}

sub update_users_DB {
	
	print <<EOD;
	This is a stub for update_users_DB ...

tasks should be in DB sysadmin.phas_aux update status
file_disposition & date (either suspended or deletion)

EOD
	return;
}

sub Delete_Windows {	# Delete account from Windows domain

	my $userid = shift;
	print "Deleting acct from Windows PDC...";
   
    &exe_cmd("$ssh_cmd administrator\@phaspdc powershell.exe -InputFormat None d:\\\\scripts\\\\RemoveUser.ps1 $userid >/dev/null");

	print "\n--------------------------------------\n";


}